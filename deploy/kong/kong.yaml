_format_version: "3.0"
_transform: true

plugins:
  - name: cors
    config:
      origins:
        - "*"
      methods:
        - GET
        - POST
        - PUT
        - DELETE
        - OPTIONS
      headers:
        - Authorization
        - Content-Type
        - X-API-Key
      exposed_headers:
        - Retry-After
      credentials: false
  - name: file-log
    config:
      path: /tmp/kong.log

services:
  - name: auth-service
    url: http://auth:8080
    routes:
      - name: auth-login
        paths: ["/auth/login"]
        methods: ["POST"]
        strip_path: false
      - name: auth-refresh
        paths: ["/auth/refresh"]
        methods: ["POST"]
        strip_path: false
      - name: auth-logout
        paths: ["/auth/logout"]
        methods: ["POST"]
        strip_path: false

  - name: user-service
    url: http://user:8081
    routes:
      - name: user-me
        paths: ["/me"]
        methods: ["GET"]
        strip_path: false
      - name: user-accounts
        paths: ["/accounts"]
        methods: ["GET"]
        strip_path: false
      - name: user-balances
        paths: ["/balances"]
        methods: ["GET"]
        strip_path: false
      - name: user-api-keys
        paths: ["/api-keys"]
        methods: ["GET", "POST", "DELETE"]
        strip_path: false
        plugins:
          - name: key-auth
            config:
              key_names: ["X-API-Key"]
              anonymous: cex-anon

  - name: trading-service
    url: http://trading:8080
    routes:
      - name: trading-orders
        paths: ["/orders"]
        methods: ["GET", "POST", "DELETE"]
        strip_path: false
        plugins:
          - name: key-auth
            config:
              key_names: ["X-API-Key"]

consumers:
  - username: cex-auth
    jwt_secrets:
      - key: cex-auth
        secret: ${CEX_JWT_SECRET:-dev-secret-change-in-production-min-32-chars}
  - username: cex-anon
